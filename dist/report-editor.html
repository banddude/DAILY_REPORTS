<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Daily Report</title>
    <style>
        :root {
            --primary-text-color: #1f2328;
            --secondary-text-color: #656d76;
            --accent-color: #007aff;
            --background-color: #ffffff;
            --section-background-color: #f6f8fa;
            --border-color: #d0d7de;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            --border-radius: 6px;
            --danger-color: #dc3545;
            --success-color: #28a745;
        }
        /* Base styles similar to viewer */
        body { font-family: var(--font-family); margin: 0; padding: 0; background-color: var(--background-color); color: var(--primary-text-color); line-height: 1.6; }
        .container { max-width: 900px; margin: 40px auto; padding: 30px; background-color: var(--background-color); border: 1px solid var(--border-color); border-radius: var(--border-radius); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); position: relative; /* For save button positioning */ }
        #logoContainer img { max-height: 60px; max-width: 200px; margin-bottom: 15px; }
        h1 { font-size: 1.8em; font-weight: 600; margin: 10px 0 5px 0; color: var(--primary-text-color); }
        .meta-info { font-size: 0.9em; color: var(--secondary-text-color); margin-bottom: 5px; }
        .company-info { font-size: 0.9em; margin-top: 10px; }
        .company-info strong { display: block; font-weight: 500; margin-bottom: 3px; }
        h2 { font-size: 1.4em; font-weight: 600; color: var(--primary-text-color); margin-top: 35px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); }
        .section { margin-bottom: 30px; }
        .section p, .section ul { margin-top: 0; }
        ul { list-style: none; padding-left: 0; }
        li { margin-bottom: 8px; }
        a { color: var(--accent-color); text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* --- Editor Specific Styles --- */
        .editable {
            padding: 8px;
            border: 1px dashed var(--border-color);
            border-radius: var(--border-radius);
            min-height: 1.5em; /* Ensure it's clickable */
            cursor: text;
            transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out;
            background-color: #fff; /* Default white background */
        }
        .editable:hover, .editable:focus {
            border-color: var(--accent-color);
            background-color: #f0f8ff; /* Light blue on hover/focus */
            outline: none;
        }
        .editable[placeholder]:empty:before {
            content: attr(placeholder);
            color: var(--secondary-text-color);
            opacity: 0.7;
        }
        /* Style list items within editable lists */
        .editable-list li {
            border: 1px solid #eee;
            background-color: #fff;
            padding: 5px 8px 5px 30px; /* Adjust padding for buttons */
            margin-bottom: 5px;
            border-radius: 4px;
            position: relative; /* For positioning buttons */
        }
        .editable-list li .editable {
            display: inline-block; /* Allow editing within the list item */
            width: calc(100% - 50px); /* Adjust width to leave space for button */
            min-height: 1em;
            padding: 2px 4px;
            vertical-align: middle;
            border: 1px dashed transparent; /* Hide border unless focused */
        }
         .editable-list li .editable:hover, .editable-list li .editable:focus {
            border-color: var(--accent-color);
            background-color: #f0f8ff;
        }
        .editable-list li .remove-item-btn {
             position: absolute;
             right: 5px;
             top: 50%;
             transform: translateY(-50%);
             cursor: pointer;
             color: var(--danger-color);
             font-weight: bold;
             font-size: 1.1em;
             padding: 0 5px;
             border: none;
             background: none;
        }
        .add-item-btn {
            display: inline-block;
            margin-top: 10px;
            padding: 5px 10px;
            font-size: 0.9em;
            cursor: pointer;
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
            border-radius: var(--border-radius);
        }
        /* Image editing placeholder */
         .image-gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 15px; }
         .image-item { text-align: center; background-color: var(--section-background-color); border: 1px solid var(--border-color); padding: 15px; border-radius: var(--border-radius); display: flex; flex-direction: column; justify-content: space-between; }
         .image-item img { max-width: 100%; height: auto; max-height: 250px; display: block; margin: 5px auto 10px auto; border-radius: calc(var(--border-radius) - 2px); border: 1px solid #ccc; } 
         .caption { font-size: 0.9em; color: var(--secondary-text-color); margin-top: auto; line-height: 1.4; }
         .caption .editable { width: 100%; box-sizing: border-box; margin-top: 5px; } /* Make caption editable */
         .placeholder-text { color: var(--danger-color); font-style: italic; padding: 10px; }


        #saveButton {
            padding: 10px 18px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            transition: background-color 0.2s ease-in-out;
        }
        #saveButton:hover { background-color: #0056b3; }
        #saveButton:disabled { background-color: #ccc; cursor: not-allowed; }

        #statusMessage {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: var(--border-radius);
            font-weight: 500;
            display: none; /* Hidden by default */
        }
        #statusMessage.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;}
        #statusMessage.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
         .error-message { color: var(--danger-color); font-weight: bold; text-align: center; margin-top: 50px; padding: 20px; border: 1px solid var(--danger-color); background-color: #f8d7da; border-radius: var(--border-radius); }

        /* --- Image Editing Enhancements --- */
        /* Remove frame-list-container styles */
        .frame-item { /* Keep basic frame item style for current images */
            background-color: var(--section-background-color);
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: var(--border-radius);
            text-align: center;
            position: relative; /* For remove button */
            font-size: 0.9em;
        }
        .frame-item img {
            max-width: 100%;
            height: auto;
            max-height: 250px; /* Back to larger previews for main gallery */
            display: block;
            margin: 5px auto 10px auto;
            border-radius: calc(var(--border-radius) - 2px);
            border: 1px solid #ccc;
        }
         /* Keep .caption styles */
         .caption { font-size: 0.9em; color: var(--secondary-text-color); margin-top: auto; line-height: 1.4; }
         .caption .editable { width: 100%; box-sizing: border-box; margin-top: 5px; } /* Make caption editable */

        .frame-action-btn {
            display: block;
            width: 80%;
            margin: 10px auto 0 auto; /* Add more margin */
            padding: 6px 10px;
            font-size: 0.9em;
            cursor: pointer;
            border-radius: var(--border-radius);
            border: 1px solid transparent;
            transition: background-color 0.2s, border-color 0.2s;
        }
        /* Keep remove-frame-btn styles */
        .remove-frame-btn { background-color: #fce8e6; color: #c53929; border-color: #f4c7c3; }
        .remove-frame-btn:hover { background-color: #f8d7da; }

        #uploadImageContainer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        #uploadImageButton {
            display: inline-block;
            padding: 8px 15px;
            font-size: 0.9em;
            cursor: pointer;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            transition: background-color 0.2s ease-in-out;
            margin-right: 10px;
        }
         #uploadImageButton:hover { background-color: #0056b3; }
         #uploadImageButton:disabled { background-color: #ccc; cursor: not-allowed; }
        #uploadStatus {
             display: inline-block;
             font-size: 0.9em;
             color: var(--secondary-text-color);
        }

    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <div class="container">
        <header>
            <div id="logoContainer"></div>
            <h1>Edit Daily Report</h1>
            <div class="meta-info" id="reportDate">Loading date...</div>
            <div class="meta-info" id="preparedBy">Loading info...</div>
            <div class="meta-info company-info" id="companyInfo">Loading company info...</div>
            <div id="statusMessage"></div>
        </header>

        <div style="text-align: right; margin-bottom: 20px; margin-top: -10px;"> 
             <button id="saveButton" disabled>Save Changes</button>
        </div>

        <main id="reportContent" style="display: none;"> <!-- Hide until data loaded -->
             <div class="section">
                <h2>Narrative</h2>
                <div id="narrative" class="editable" contenteditable="true" placeholder="Enter narrative..."></div>
            </div>

            <div class="section">
                <h2>Work Completed</h2>
                <ul id="workCompleted" class="editable-list"><li>Loading...</li></ul>
                 <button class="add-item-btn" data-list-id="workCompleted" data-type="simple">Add Work Item</button>
            </div>

             <div class="section">
                <h2>Issues</h2>
                 <ul id="issues" class="editable-list"><li>Loading...</li></ul>
                 <button class="add-item-btn" data-list-id="issues" data-type="issue">Add Issue</button>
            </div>

             <div class="section">
                <h2>Materials</h2>
                 <ul id="materials" class="editable-list"><li>Loading...</li></ul>
                  <button class="add-item-btn" data-list-id="materials" data-type="material">Add Material</button>
            </div>

            <div class="section">
                <h2>Safety Observations</h2>
                 <div id="safetyObservations" class="editable" contenteditable="true" placeholder="Enter safety observations..."></div>
            </div>

             <div class="section">
                <h2>Next Steps</h2>
                 <ul id="nextSteps" class="editable-list"><li>Loading...</li></ul>
                 <button class="add-item-btn" data-list-id="nextSteps" data-type="simple">Add Next Step</button>
            </div>

            <div class="section">
                <h2>Images</h2>
                <p style="font-size: 0.8em; color: var(--secondary-text-color); margin-bottom: 15px;">Edit captions or remove images currently in the report. Add new images using the upload button below.</p>
                <div class="image-gallery" id="imagesContainer">Loading...</div>

                <!-- New Section for Uploading Images -->
                <div id="uploadImageContainer">
                    <h3>Upload New Image</h3>
                    <input type="file" id="imageFileInput" accept="image/jpeg, image/png, image/gif, image/webp" style="display: none;">
                    <button id="uploadImageButton">Choose Image...</button>
                    <span id="uploadStatus"></span>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentReportData = null; // Store the fetched data globally within the script scope
        let reportKey = ''; // Store the S3 key for saving
        let imageBaseUrl = '';

        document.addEventListener('DOMContentLoaded', () => {
            const saveButton = document.getElementById('saveButton');
            const statusMessage = document.getElementById('statusMessage');
            const reportContent = document.getElementById('reportContent');
            const uploadButton = document.getElementById('uploadImageButton');
            const fileInput = document.getElementById('imageFileInput');

            // Get the report key from URL query parameter
            const urlParams = new URLSearchParams(window.location.search);
            reportKey = urlParams.get('key');

            if (!reportKey) {
                showError("Error: Report key missing from URL query parameter (?key=...). Cannot load or save report.");
                return;
            }

            // Fetch the initial data
            fetch(`/api/report?key=${encodeURIComponent(reportKey)}`)
                .then(response => {
                     if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || `HTTP error! status: ${response.status}`); });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Report data loaded:", data);
                    currentReportData = data; // Store fetched data
                    imageBaseUrl = getBaseS3Url(data);
                    populateForm(data);
                    renderCurrentImageGallery();
                    reportContent.style.display = 'block'; // Show content
                    saveButton.disabled = false; // Enable save button
                })
                .catch(error => {
                    console.error('Error loading report data:', error);
                     showError(`Error loading report: ${error.message}`);
                });

            // Save button functionality
            saveButton.addEventListener('click', () => {
                 collectChanges();
                 saveChanges();
            });

             // Event delegation for adding/removing list items
             document.addEventListener('click', (event) => {
                const target = event.target;
                if (target.classList.contains('add-item-btn')) {
                    const listId = target.dataset.listId;
                    const itemType = target.dataset.type;
                    addItemToList(listId, itemType);
                } else if (target.classList.contains('remove-item-btn')) {
                     const listItem = target.closest('li');
                     if (listItem) {
                         listItem.remove(); // Remove from DOM immediately
                     }
                }
             });

            // --- Add Event Delegation for Image Removal (Upload handled separately) --- 
             document.addEventListener('click', (event) => {
                 const target = event.target;
                if (target.classList.contains('remove-frame-btn')) {
                    handleRemoveFrame(target.dataset.filename);
                }
            });

            // --- Add Event Listener for Caption Editing --- 
             document.addEventListener('input', updateCaptionFromEditable);
             
             // --- Add Event Listeners for Image Upload --- 
             uploadButton.addEventListener('click', triggerImageUpload);
             fileInput.addEventListener('change', handleImageFileSelect);
        });

        function populateForm(data) {
            if (!data) return; // Add check for data
            // --- Populate Metadata (Read-only in editor) ---
            const meta = data.reportMetadata || {};
            const company = meta.companyInfo || {};
            const prepared = meta.preparedBy || {};
            const address = company.address || {};
            const assets = data.reportAssetsS3Urls || {};

            const logoContainer = document.getElementById('logoContainer');
            if (assets.logoUrl) { logoContainer.innerHTML = `<img src="${assets.logoUrl}" alt="${company.name || 'Company'} Logo">`; }
            // Use reportMetadata for date if available, fallback to parsing URL
            setText('reportDate', `Date: ${meta.date || assets.baseUrl?.match(/report_(\d{4}-\d{2}-\d{2})/)?.[1] || 'N/A'}`);
            setText('preparedBy', `Prepared By: ${prepared.name || 'N/A'} ${prepared.email ? ' (' + prepared.email + ')' : ''}`);
            let companyHtml = `<strong>${company.name || 'N/A'}</strong>`;
            if (address.street) companyHtml += `${address.street}${address.unit ? ' #' + address.unit : ''}<br>`;
            if (address.city || address.state || address.zip) companyHtml += `${address.city || ''}${address.city && address.state ? ', ' : ''}${address.state || ''} ${address.zip || ''}<br>`;
            if (company.phone) companyHtml += `Phone: ${company.phone} | `;
            if (company.website) companyHtml += `Website: <a href="${company.website}" target="_blank">${company.website}</a>`;
            setHtml('companyInfo', companyHtml.replace(/ \| $/, ''));

            // --- Populate Editable Fields ---
            setEditableHtml('narrative', data.narrative || '');
            setEditableHtml('safetyObservations', data.safetyObservations || '');

            // --- Populate Editable Lists ---
            populateEditableList('workCompleted', data.workCompleted, 'simple');
            populateEditableList('nextSteps', data.nextSteps, 'simple');
            populateEditableList('materials', data.materials, 'material');
            populateEditableList('issues', data.issues, 'issue');
            
            // --- DO NOT Populate Images Here --- 
            // The images are populated by renderCurrentImageGallery() called from DOMContentLoaded
        }

         // Helper to set content of contenteditable divs
        function setEditableHtml(elementId, content) {
             const el = document.getElementById(elementId);
            if (el) { el.innerHTML = content; } // Use innerHTML for potential formatting
        }
         function setText(elementId, text) {
            const el = document.getElementById(elementId);
            if (el) { el.textContent = text; }
        }
        function setHtml(elementId, html) {
             const el = document.getElementById(elementId);
            if (el) { el.innerHTML = html; }
        }


        function populateEditableList(listId, items, itemType) {
             const list = document.getElementById(listId);
            if (!list) return;
            list.innerHTML = ''; // Clear loading/previous
            if (items && items.length > 0) {
                items.forEach(item => addListItem(listId, itemType, item));
            } else {
                // Optionally add a placeholder or leave empty
                // list.innerHTML = '<li>No items yet.</li>';
            }
        }

        function addListItem(listId, itemType, itemData = null) {
             const list = document.getElementById(listId);
             if (!list) return;

             const li = document.createElement('li');
             li.dataset.itemType = itemType; // Store type for saving

            let contentHtml = '';
            if (itemType === 'simple') {
                 li.innerHTML = `<div class="editable" contenteditable="true">${itemData || ''}</div>`;
            } else if (itemType === 'material') {
                const data = itemData || { materialName: '', status: '', note: '' };
                 li.dataset.materialName = data.materialName; // Store original data if needed
                 li.dataset.status = data.status;
                 li.dataset.note = data.note;
                 li.innerHTML = `
                    Name: <div class="editable" contenteditable="true" data-field="materialName">${data.materialName}</div><br>
                    Status: <div class="editable" contenteditable="true" data-field="status">${data.status}</div><br>
                    Note: <div class="editable" contenteditable="true" data-field="note">${data.note}</div>
                 `;
            } else if (itemType === 'issue') {
                 const data = itemData || { description: '', status: 'Open', impact: '', resolution: '' };
                 li.dataset.description = data.description; // Store original data if needed
                 li.dataset.status = data.status;
                 li.dataset.impact = data.impact;
                 li.dataset.resolution = data.resolution;
                 li.innerHTML = `
                    Desc: <div class="editable" contenteditable="true" data-field="description">${data.description}</div><br>
                    Status: <select data-field="status">
                                <option value="Open" ${data.status === 'Open' ? 'selected' : ''}>Open</option>
                                <option value="Resolved" ${data.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                                <option value="Needs Monitoring" ${data.status === 'Needs Monitoring' ? 'selected' : ''}>Needs Monitoring</option>
                             </select><br>
                    Impact: <div class="editable" contenteditable="true" data-field="impact">${data.impact}</div><br>
                    Resolution: <div class="editable" contenteditable="true" data-field="resolution">${data.resolution}</div>
                 `;
            }

            // Add remove button
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-item-btn';
            removeBtn.innerHTML = '&times;'; // Multiplication sign as 'X'
            removeBtn.title = 'Remove item';
            li.appendChild(removeBtn);

             list.appendChild(li);
        }

         function addItemToList(listId, itemType) {
            // Calls addListItem with null data to add a blank entry
            addListItem(listId, itemType, null);
         }

        function collectEditedData() {
             const updatedData = JSON.parse(JSON.stringify(currentReportData)); // Deep clone the original data

            // Update single fields
            updatedData.narrative = document.getElementById('narrative')?.innerHTML || '';
            updatedData.safetyObservations = document.getElementById('safetyObservations')?.innerHTML || '';

            // Update lists
            updatedData.workCompleted = collectListItems('workCompleted', 'simple');
            updatedData.nextSteps = collectListItems('nextSteps', 'simple');
            updatedData.materials = collectListItems('materials', 'material');
            updatedData.issues = collectListItems('issues', 'issue');

            // Update image captions
             const imageItems = document.querySelectorAll('#imagesContainer .image-item');
             imageItems.forEach((itemDiv, index) => {
                 const captionEditable = itemDiv.querySelector('.caption .editable');
                 // Find the corresponding image in the original data based on filename/S3 URL if index isn't reliable
                 // For simplicity, this assumes the order hasn't changed and matches the original index.
                 if (updatedData.images && updatedData.images[index] && captionEditable) {
                     updatedData.images[index].caption = captionEditable.innerHTML;
                 }
             });


             return updatedData;
        }

        function collectListItems(listId, itemType) {
            const list = document.getElementById(listId);
            if (!list) return [];

            const items = [];
            const listItems = list.querySelectorAll('li');

            listItems.forEach(li => {
                if (itemType === 'simple') {
                    const editableDiv = li.querySelector('.editable');
                    if (editableDiv && editableDiv.innerHTML.trim()) { // Only add non-empty items
                       items.push(editableDiv.innerHTML);
                     }
                } else if (itemType === 'material') {
                    const material = {};
                    let hasName = false;
                    li.querySelectorAll('[data-field]').forEach(field => {
                        material[field.dataset.field] = field.innerHTML;
                        if(field.dataset.field === 'materialName' && field.innerHTML.trim()) {
                            hasName = true;
                        }
                    });
                     // Only add if materialName has content
                    if (hasName) {
                        items.push(material);
                    }
                } else if (itemType === 'issue') {
                     const issue = {};
                     let hasDesc = false;
                    li.querySelectorAll('[data-field]').forEach(field => {
                         if (field.tagName === 'SELECT') {
                             issue[field.dataset.field] = field.value;
                         } else {
                             issue[field.dataset.field] = field.innerHTML;
                             if(field.dataset.field === 'description' && field.innerHTML.trim()) {
                                 hasDesc = true;
                             }
                         }
                     });
                      // Only add if description has content
                    if (hasDesc) {
                        items.push(issue);
                    }
                }
            });
            return items;
        }


        function saveChanges() {
            const saveButton = document.getElementById('saveButton');
            const statusMessage = document.getElementById('statusMessage');
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';
            showStatus('', ''); // Clear previous status

            const updatedData = collectEditedData();
            console.log("Saving data:", updatedData);

            fetch(`/api/report?key=${encodeURIComponent(reportKey)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updatedData),
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || `Save failed! Status: ${response.status}`); });
                }
                return response.json();
            })
            .then(result => {
                console.log("Save successful:", result);
                currentReportData = updatedData; // Update global data state on successful save
                showStatus(result.message || 'Report saved successfully!', 'success');
            })
            .catch(error => {
                console.error('Error saving report:', error);
                showStatus(`Error saving report: ${error.message}`, 'error');
            })
            .finally(() => {
                saveButton.disabled = false;
                saveButton.textContent = 'Save Changes';
                // Hide status message after a delay
                setTimeout(() => { showStatus('', ''); }, 5000);
            });
        }

        function showStatus(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            if (!statusMessage) return;
            if (message) {
                 statusMessage.textContent = message;
                 statusMessage.className = type; // 'success' or 'error'
                 statusMessage.style.display = 'block';
            } else {
                 statusMessage.style.display = 'none';
                 statusMessage.className = '';
            }
        }
         function showError(message) {
             const reportContent = document.getElementById('reportContent');
             if (reportContent) reportContent.style.display = 'none'; // Hide form
             document.body.innerHTML = `<div class="container error-message"><h1>Error</h1><p>${message}</p></div>`;
         }

        function getBaseS3Url(reportData) {
            return reportData?.reportAssetsS3Urls?.baseUrl || '';
        }
        function buildFrameUrl(baseUrl, frameFilename) {
            if (!baseUrl || !frameFilename) return '';
            const framesSubDir = 'extracted_frames'; // Assuming this is consistent
            // Ensure no double slashes
            baseUrl = baseUrl.endsWith('/') ? baseUrl : baseUrl + '/';
            return `${baseUrl}${framesSubDir}/${frameFilename}`;
        }

        function renderCurrentImageGallery() {
            const container = document.getElementById('imagesContainer');
            if (!container) return;
            if (!currentReportData || !currentReportData.images || currentReportData.images.length === 0) {
                container.innerHTML = '<p class="placeholder-text">No images currently added to the report.</p>';
                return;
            }

            container.innerHTML = ''; // Clear previous content
            imageBaseUrl = getBaseS3Url(currentReportData);

            currentReportData.images.forEach((imgData, index) => {
                if (!imgData || !imgData.fileName) return; // Skip invalid entries
                
                // Use the pre-stored s3Url if available, otherwise build it
                const imageUrl = imgData.s3Url || buildFrameUrl(imageBaseUrl, imgData.fileName);

                const div = document.createElement('div');
                 div.classList.add('frame-item');
                div.innerHTML = `
                    <img src="${imageUrl || 'placeholder.png'}" alt="${imgData.caption || 'Report image'}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div style="display:none; color: red; font-size: 0.8em; padding: 10px;">Image not found or missing</div>
                    <div class="caption">
                        <div class="editable caption-editable" contenteditable="true" data-image-index="${index}" placeholder="Enter caption...">${imgData.caption || ''}</div>
                    </div>
                    <button class="frame-action-btn remove-frame-btn" data-filename="${imgData.fileName}">Remove from Report</button>
                `;
                container.appendChild(div);
            });
        }

        async function handleRemoveFrame(filename) {
            if (!currentReportData || !currentReportData.images) return;
            
            // Optional: Confirm before removing
            if (!confirm(`Are you sure you want to remove the image reference '${filename}' from the report? The file itself will remain in S3.`)) {
                return;
            }
            
            // Show loading state (optional)
            console.log(`Attempting to remove ${filename}...`);
            // You could add a visual indicator here if needed
            
            try {
                const response = await fetch(`/api/remove-image?key=${encodeURIComponent(reportKey)}&fileName=${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });

                const result = await response.json(); // Get response body

                if (!response.ok) {
                    throw new Error(result.error || `Failed to remove image: ${response.status}`);
                }
                
                console.log("Remove successful:", result);

                // Update local data with the array returned from the backend
                if (result.updatedImages) {
                    currentReportData.images = result.updatedImages;
                } else {
                     // Fallback (shouldn't be needed)
                     console.warn("Backend did not return updated image array after removal.");
                     currentReportData.images = currentReportData.images.filter(img => img.fileName !== filename);
                }

                // Re-render the gallery
                renderCurrentImageGallery();

            } catch (error) {
                 console.error('Error removing image:', error);
                 alert(`Error removing image: ${error.message}`); // Show error to user
            }
        }

        function updateCaptionFromEditable(event) {
             const target = event.target;
             if (target.classList.contains('caption-editable')) {
                const index = parseInt(target.dataset.imageIndex, 10);
                const newCaption = target.innerText.trim();
                if (currentReportData && currentReportData.images && currentReportData.images[index]) {
                    currentReportData.images[index].caption = newCaption;
                     console.log(`Updated caption for index ${index} to: ${newCaption}`);
                }
            }
        }

        function triggerImageUpload() {
            document.getElementById('imageFileInput').click();
        }

        async function handleImageFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const uploadButton = document.getElementById('uploadImageButton');
            const uploadStatus = document.getElementById('uploadStatus');

            uploadButton.disabled = true;
            uploadStatus.textContent = 'Uploading...';
            uploadStatus.style.color = 'var(--secondary-text-color)';

            const formData = new FormData();
            formData.append('newImage', file);

            try {
                const response = await fetch(`/api/upload-image?key=${encodeURIComponent(reportKey)}`, {
                    method: 'POST',
                    body: formData,
                    // No 'Content-Type' header - browser sets it correctly for FormData
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `Upload failed: ${response.status}`);
                }

                console.log('Upload successful:', result);
                uploadStatus.textContent = 'Upload successful! Image added to report.'; // Update status
                uploadStatus.style.color = 'var(--success-color)';

                // Update the local data with the array returned from the backend
                if (result.updatedImages) {
                    currentReportData.images = result.updatedImages;
                } else {
                    // Fallback if backend didn't return updated array (shouldn't happen now)
                    if (!currentReportData.images) {
                        currentReportData.images = [];
                    }
                     // Find the newly added image by fileName or s3Url if needed, 
                     // but ideally the backend sends the whole array back.
                     console.warn("Backend did not return updated image array, performing manual add (might cause issues).");
                     currentReportData.images.push({
                         fileName: result.fileName,
                         caption: "", // Add with empty caption
                         s3Url: result.s3Url
                     });
                }
                
                renderCurrentImageGallery(); // Update the gallery immediately
                // uploadStatus.textContent = 'Image added to report.'; // Status already set

            } catch (error) {
                console.error('Error uploading image:', error);
                uploadStatus.textContent = `Upload failed: ${error.message}`;
                uploadStatus.style.color = 'var(--danger-color)';
            } finally {
                uploadButton.disabled = false;
                // Clear the file input value so the same file can be selected again if needed
                event.target.value = null; 
                 // Optionally clear status after delay
                 setTimeout(() => { uploadStatus.textContent = ''; }, 5000);
            }
        }

        function collectChanges() {
             if (!currentReportData) return;

            // Collect simple text fields
            currentReportData.narrative = document.getElementById('narrative')?.textContent.trim() || '';
            currentReportData.safetyObservations = document.getElementById('safetyObservations')?.textContent.trim() || '';

            // Collect list items
            currentReportData.workCompleted = collectListItems('workCompleted', 'simple');
            currentReportData.issues = collectListItems('issues', 'issue');
            currentReportData.materials = collectListItems('materials', 'material');
            currentReportData.nextSteps = collectListItems('nextSteps', 'simple');
            
            // Captions are updated via event listener 'updateCaptionFromEditable'
            // The currentReportData.images array is modified directly by add/remove/upload handlers
            console.log("Collected changes:", currentReportData);
        }

    </script>
    <script src="include-header.js"></script>
</body>
</html>
