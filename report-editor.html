<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Daily Report</title>
    <style>
        :root {
            --primary-text-color: #1f2328;
            --secondary-text-color: #656d76;
            --accent-color: #007aff;
            --background-color: #ffffff;
            --section-background-color: #f6f8fa;
            --border-color: #d0d7de;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            --border-radius: 6px;
            --danger-color: #dc3545;
            --success-color: #28a745;
        }
        /* Base styles similar to viewer */
        body { font-family: var(--font-family); margin: 0; padding: 0; background-color: var(--background-color); color: var(--primary-text-color); line-height: 1.6; }
        .container { max-width: 900px; margin: 40px auto; padding: 30px; background-color: var(--background-color); border: 1px solid var(--border-color); border-radius: var(--border-radius); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); position: relative; /* For save button positioning */ }
        #logoContainer img { max-height: 60px; max-width: 200px; margin-bottom: 15px; }
        h1 { font-size: 1.8em; font-weight: 600; margin: 10px 0 5px 0; color: var(--primary-text-color); }
        .meta-info { font-size: 0.9em; color: var(--secondary-text-color); margin-bottom: 5px; }
        .company-info { font-size: 0.9em; margin-top: 10px; }
        .company-info strong { display: block; font-weight: 500; margin-bottom: 3px; }
        h2 { font-size: 1.4em; font-weight: 600; color: var(--primary-text-color); margin-top: 35px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); }
        .section { margin-bottom: 30px; }
        .section p, .section ul { margin-top: 0; }
        ul { list-style: none; padding-left: 0; }
        li { margin-bottom: 8px; }
        a { color: var(--accent-color); text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* --- Editor Specific Styles --- */
        .editable {
            padding: 8px;
            border: 1px dashed var(--border-color);
            border-radius: var(--border-radius);
            min-height: 1.5em; /* Ensure it's clickable */
            cursor: text;
            transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out;
            background-color: #fff; /* Default white background */
        }
        .editable:hover, .editable:focus {
            border-color: var(--accent-color);
            background-color: #f0f8ff; /* Light blue on hover/focus */
            outline: none;
        }
        .editable[placeholder]:empty:before {
            content: attr(placeholder);
            color: var(--secondary-text-color);
            opacity: 0.7;
        }
        /* Style list items within editable lists */
        .editable-list li {
            border: 1px solid #eee;
            background-color: #fff;
            padding: 5px 8px 5px 30px; /* Adjust padding for buttons */
            margin-bottom: 5px;
            border-radius: 4px;
            position: relative; /* For positioning buttons */
        }
        .editable-list li .editable {
            display: inline-block; /* Allow editing within the list item */
            width: calc(100% - 50px); /* Adjust width to leave space for button */
            min-height: 1em;
            padding: 2px 4px;
            vertical-align: middle;
            border: 1px dashed transparent; /* Hide border unless focused */
        }
         .editable-list li .editable:hover, .editable-list li .editable:focus {
            border-color: var(--accent-color);
            background-color: #f0f8ff;
        }
        .editable-list li .remove-item-btn {
             position: absolute;
             right: 5px;
             top: 50%;
             transform: translateY(-50%);
             cursor: pointer;
             color: var(--danger-color);
             font-weight: bold;
             font-size: 1.1em;
             padding: 0 5px;
             border: none;
             background: none;
        }
        .add-item-btn {
            display: inline-block;
            margin-top: 10px;
            padding: 5px 10px;
            font-size: 0.9em;
            cursor: pointer;
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
            border-radius: var(--border-radius);
        }
        /* Image editing placeholder */
         .image-gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 15px; }
         .image-item { text-align: center; background-color: var(--section-background-color); border: 1px solid var(--border-color); padding: 15px; border-radius: var(--border-radius); display: flex; flex-direction: column; justify-content: space-between; }
         .image-item img { max-width: 100%; height: auto; max-height: 250px; display: block; margin: 5px auto 10px auto; border-radius: calc(var(--border-radius) - 2px); border: 1px solid #ccc; } 
         .caption { font-size: 0.9em; color: var(--secondary-text-color); margin-top: auto; line-height: 1.4; }
         .caption .editable { width: 100%; box-sizing: border-box; margin-top: 5px; } /* Make caption editable */
         .placeholder-text { color: var(--danger-color); font-style: italic; padding: 10px; }


        #saveButton {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 10px 18px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            transition: background-color 0.2s ease-in-out;
        }
        #saveButton:hover { background-color: #0056b3; }
        #saveButton:disabled { background-color: #ccc; cursor: not-allowed; }

        #statusMessage {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: var(--border-radius);
            font-weight: 500;
            display: none; /* Hidden by default */
        }
        #statusMessage.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;}
        #statusMessage.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
         .error-message { color: var(--danger-color); font-weight: bold; text-align: center; margin-top: 50px; padding: 20px; border: 1px solid var(--danger-color); background-color: #f8d7da; border-radius: var(--border-radius); }

        /* --- Image Editing Enhancements --- */
        #imageManagementContainer { margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        #imageManagementContainer h3 { font-size: 1.2em; margin-bottom: 15px; color: var(--primary-text-color); }
        .frame-list-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .frame-item {
            background-color: var(--section-background-color);
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: var(--border-radius);
            text-align: center;
            position: relative;
            font-size: 0.9em;
        }
        .frame-item img {
            max-width: 100%;
            height: auto;
            max-height: 100px; /* Smaller previews */
            display: block;
            margin: 5px auto 10px auto;
            border-radius: calc(var(--border-radius) - 2px);
            border: 1px solid #ccc;
        }
        .frame-item .frame-filename { word-wrap: break-word; margin-bottom: 8px; color: var(--secondary-text-color); font-size: 0.9em; }
        .frame-action-btn {
            display: block;
            width: 80%;
            margin: 5px auto 0 auto;
            padding: 6px 10px;
            font-size: 0.9em;
            cursor: pointer;
            border-radius: var(--border-radius);
            border: 1px solid transparent;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .add-frame-btn { background-color: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; }
        .add-frame-btn:hover { background-color: #c8e6c9; }
        .remove-frame-btn { background-color: #fce8e6; color: #c53929; border-color: #f4c7c3; }
        .remove-frame-btn:hover { background-color: #f8d7da; }

        /* Make editable captions smaller */
        .image-gallery .caption .editable {
             width: 100%;
             box-sizing: border-box;
             margin-top: 5px;
             padding: 4px 6px;
             font-size: 0.9em; /* Smaller font for captions */
             min-height: 1.2em;
         }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <div id="logoContainer"></div>
            <h1>Edit Daily Report</h1>
            <div class="meta-info" id="reportDate">Loading date...</div>
            <div class="meta-info" id="preparedBy">Loading info...</div>
            <div class="meta-info company-info" id="companyInfo">Loading company info...</div>
            <button id="saveButton" disabled>Save Changes</button>
            <div id="statusMessage"></div>
        </header>

        <main id="reportContent" style="display: none;"> <!-- Hide until data loaded -->
             <div class="section">
                <h2>Narrative</h2>
                <div id="narrative" class="editable" contenteditable="true" placeholder="Enter narrative..."></div>
            </div>

            <div class="section">
                <h2>Work Completed</h2>
                <ul id="workCompleted" class="editable-list"><li>Loading...</li></ul>
                 <button class="add-item-btn" data-list-id="workCompleted" data-type="simple">Add Work Item</button>
            </div>

             <div class="section">
                <h2>Issues</h2>
                 <ul id="issues" class="editable-list"><li>Loading...</li></ul>
                 <button class="add-item-btn" data-list-id="issues" data-type="issue">Add Issue</button>
            </div>

             <div class="section">
                <h2>Materials</h2>
                 <ul id="materials" class="editable-list"><li>Loading...</li></ul>
                  <button class="add-item-btn" data-list-id="materials" data-type="material">Add Material</button>
            </div>

            <div class="section">
                <h2>Safety Observations</h2>
                 <div id="safetyObservations" class="editable" contenteditable="true" placeholder="Enter safety observations..."></div>
            </div>

             <div class="section">
                <h2>Next Steps</h2>
                 <ul id="nextSteps" class="editable-list"><li>Loading...</li></ul>
                 <button class="add-item-btn" data-list-id="nextSteps" data-type="simple">Add Next Step</button>
            </div>

            <div class="section">
                <h2>Images</h2>
                <p style="font-size: 0.8em; color: var(--secondary-text-color); margin-bottom: 15px;">Edit captions for images currently in the report. Images will only appear here if they have been added below.</p>
                <div class="image-gallery" id="imagesContainer">Loading...</div>

                <!-- New Section for Adding/Removing Images -->
                <div id="imageManagementContainer">
                    <h3>Manage Report Images</h3>
                    <div id="availableFramesContainer">
                        <h4>Available Frames</h4>
                        <div class="frame-list-container" id="availableFramesList">Loading available frames...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentReportData = null;
        let reportKey = '';
        let availableFrameFiles = []; // Store the list of all frame files from S3
        let imageBaseUrl = ''; // Store the base S3 URL for constructing image URLs

        // --- Helper Function to get base S3 URL from report data --- 
        function getBaseS3Url(reportData) {
            return reportData?.reportAssetsS3Urls?.baseUrl || '';
        }

        // --- Helper Function to build full S3 URL for a frame --- 
        function buildFrameUrl(baseUrl, frameFilename) {
            if (!baseUrl || !frameFilename) return '';
            const framesSubDir = 'extracted_frames'; // Assuming this is consistent
            // Ensure no double slashes
            baseUrl = baseUrl.endsWith('/') ? baseUrl : baseUrl + '/';
            return `${baseUrl}${framesSubDir}/${frameFilename}`;
        }

        // --- Update UI Functions --- 
        function renderCurrentImageGallery() {
            const container = document.getElementById('imagesContainer');
            if (!currentReportData || !currentReportData.images || currentReportData.images.length === 0) {
                container.innerHTML = '<p class="placeholder-text">No images currently added to the report.</p>';
                return;
            }

            container.innerHTML = ''; // Clear previous content
            imageBaseUrl = getBaseS3Url(currentReportData);

            currentReportData.images.forEach((imgData, index) => {
                if (!imgData || !imgData.fileName) return; // Skip invalid entries
                
                const imageUrl = buildFrameUrl(imageBaseUrl, imgData.fileName);

                const div = document.createElement('div');
                div.classList.add('image-item');
                div.innerHTML = `
                    <img src="${imageUrl || 'placeholder.png'}" alt="${imgData.caption || 'Report image'}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div style="display:none; color: red; font-size: 0.8em; padding: 10px;">Image not found or missing</div>
                    <div class="caption">
                        <div class="editable caption-editable" contenteditable="true" data-image-index="${index}" placeholder="Enter caption...">${imgData.caption || ''}</div>
                    </div>
                    <button class="frame-action-btn remove-frame-btn" data-filename="${imgData.fileName}">Remove from Report</button>
                `;
                container.appendChild(div);
            });
        }

        function renderAvailableFrames() {
            const container = document.getElementById('availableFramesList');
            if (!availableFrameFiles || availableFrameFiles.length === 0) {
                container.innerHTML = '<p class="placeholder-text">No frames found in S3.</p>';
                return;
            }

            container.innerHTML = ''; // Clear previous content
            imageBaseUrl = getBaseS3Url(currentReportData); // Ensure baseUrl is available

            const currentImageFilenames = new Set((currentReportData?.images || []).map(img => img.fileName));

            availableFrameFiles.forEach(frameFilename => {
                // Only show frames NOT currently in the report
                if (!currentImageFilenames.has(frameFilename)) {
                    const imageUrl = buildFrameUrl(imageBaseUrl, frameFilename);
                    const div = document.createElement('div');
                    div.classList.add('frame-item');
                    div.innerHTML = `
                        <img src="${imageUrl || 'placeholder.png'}" alt="${frameFilename}" onerror="this.style.display='none';">
                        <div class="frame-filename">${frameFilename}</div>
                        <button class="frame-action-btn add-frame-btn" data-filename="${frameFilename}">Add to Report</button>
                    `;
                    container.appendChild(div);
                }
            });

            if (container.innerHTML === '') {
                 container.innerHTML = '<p class="placeholder-text" style="grid-column: 1 / -1;">All available frames have been added to the report.</p>';
            }
        }

        // --- Event Handlers --- 
        function handleAddFrame(filename) {
            const caption = prompt(`Enter caption for ${filename}:`, '');
            if (caption === null) return; // User cancelled

            if (!currentReportData.images) {
                currentReportData.images = []; // Initialize if it doesn't exist
            }

            // Rebuild the image URL based on potentially updated baseUrl
            imageBaseUrl = getBaseS3Url(currentReportData);
            const imageUrl = buildFrameUrl(imageBaseUrl, filename);

            currentReportData.images.push({
                fileName: filename,
                caption: caption,
                s3Url: imageUrl // Store the constructed S3 URL
            });

            // Re-render both sections
            renderCurrentImageGallery();
            renderAvailableFrames();
        }

        function handleRemoveFrame(filename) {
            if (!currentReportData || !currentReportData.images) return;

            currentReportData.images = currentReportData.images.filter(img => img.fileName !== filename);

            // Re-render both sections
            renderCurrentImageGallery();
            renderAvailableFrames();
        }

        function updateCaptionFromEditable(event) {
             const target = event.target;
             if (target.classList.contains('caption-editable')) {
                const index = parseInt(target.dataset.imageIndex, 10);
                const newCaption = target.innerText.trim();
                if (currentReportData && currentReportData.images && currentReportData.images[index]) {
                    currentReportData.images[index].caption = newCaption;
                     console.log(`Updated caption for index ${index} to: ${newCaption}`);
                }
            }
        }


        // --- Initialization and Fetching --- 
        document.addEventListener('DOMContentLoaded', () => {
            const saveButton = document.getElementById('saveButton');
            const statusMessage = document.getElementById('statusMessage');
            const reportContent = document.getElementById('reportContent');

            const urlParams = new URLSearchParams(window.location.search);
            reportKey = urlParams.get('key');

            if (!reportKey) {
                showError("Error: Report key missing from URL query parameter (?key=...). Cannot load or save report.");
                return;
            }

            // Fetch both report data and available frames concurrently
            Promise.all([
                fetch(`/api/report?key=${encodeURIComponent(reportKey)}`).then(res => {
                    if (!res.ok) return res.json().then(err => { throw new Error(err.error || `HTTP error loading report: ${res.status}`); });
                    return res.json();
                }),
                fetch(`/api/report-frames?key=${encodeURIComponent(reportKey)}`).then(res => {
                    if (!res.ok) return res.json().then(err => { throw new Error(err.error || `HTTP error loading frames: ${res.status}`); });
                    return res.json();
                })
            ])
            .then(([reportData, framesData]) => {
                console.log("Report data loaded:", reportData);
                console.log("Available frames loaded:", framesData);
                
                currentReportData = reportData;
                availableFrameFiles = framesData.frameFiles || [];
                imageBaseUrl = getBaseS3Url(currentReportData); // Get initial base URL
                
                // Ensure image objects have s3Url populated (might be missing from older data)
                if (currentReportData && currentReportData.images) {
                     currentReportData.images.forEach(img => {
                         if (img.fileName && !img.s3Url) {
                             img.s3Url = buildFrameUrl(imageBaseUrl, img.fileName);
                         }
                     });
                }

                populateForm(currentReportData); // Populate text fields, lists etc.
                renderCurrentImageGallery(); // Populate the current image gallery
                renderAvailableFrames(); // Populate the available frames list
                
                reportContent.style.display = 'block';
                saveButton.disabled = false;
            })
            .catch(error => {
                console.error('Error loading initial data:', error);
                 showError(`Error loading data: ${error.message}`);
            });

            // Save button functionality
            saveButton.addEventListener('click', () => {
                 collectChanges(); // Collect text/list changes before saving
                 saveChanges();
            });

             // Event delegation for adding/removing list items (existing)
             document.addEventListener('click', (event) => {
                const target = event.target;
                if (target.classList.contains('add-item-btn')) {
                    const listId = target.dataset.listId;
                    const itemType = target.dataset.type;
                    addItemToList(listId, itemType);
                } else if (target.classList.contains('remove-item-btn')) {
                     const listItem = target.closest('li');
                     if (listItem) {
                         listItem.remove(); // Remove from DOM immediately
                     }
                }
            });
            
            // --- Add Event Delegation for Image Management --- 
             document.addEventListener('click', (event) => {
                 const target = event.target;
                if (target.classList.contains('add-frame-btn')) {
                    handleAddFrame(target.dataset.filename);
                } else if (target.classList.contains('remove-frame-btn')) {
                    handleRemoveFrame(target.dataset.filename);
                }
            });

            // --- Add Event Listener for Caption Editing --- 
             document.addEventListener('input', updateCaptionFromEditable);

        }); // End DOMContentLoaded

        // --- Data Population and Saving Functions (Modified/Existing) --- 

        function populateForm(data) {
            if (!data) return;
            // Populate Header
            document.getElementById('reportDate').textContent = `Date: ${data.reportMetadata?.date || 'N/A'}`;
            document.getElementById('preparedBy').textContent = `Prepared by: ${data.reportMetadata?.preparedBy?.name || 'N/A'}`;
            // ... (populate company info - needs reportMetadata structure) ... 
            const companyInfo = data.reportMetadata?.companyInfo;
            const companyDiv = document.getElementById('companyInfo');
            if (companyInfo && companyDiv) {
                companyDiv.innerHTML = ''; // Clear loading state
                if (companyInfo.name) companyDiv.innerHTML += `<strong>${companyInfo.name}</strong>`;
                if (companyInfo.address) {
                    const addressParts = [companyInfo.address.street, companyInfo.address.city, companyInfo.address.state, companyInfo.address.zip].filter(Boolean);
                    if (addressParts.length > 0) companyDiv.innerHTML += `<span>${addressParts.join(', ')}</span><br>`;
                }
                if (companyInfo.phone) companyDiv.innerHTML += `<span>Phone: ${companyInfo.phone}</span><br>`;
                if (companyInfo.website) companyDiv.innerHTML += `<span>Website: <a href="${companyInfo.website}" target="_blank">${companyInfo.website}</a></span>`;
            }
             // Populate logo if available
            const logoContainer = document.getElementById('logoContainer');
            imageBaseUrl = getBaseS3Url(data);
            const logoUrl = buildFrameUrl(imageBaseUrl, data.reportMetadata?.companyInfo?.logoFilename); // Build logo URL
            if (logoUrl && logoContainer) {
                logoContainer.innerHTML = `<img src="${logoUrl}" alt="Company Logo">`;
            }

            // Populate simple editable fields
            populateEditableField('narrative', data.narrative);
            populateEditableField('safetyObservations', data.safetyObservations);

            // Populate editable lists
            populateEditableList('workCompleted', data.workCompleted || [], 'simple');
            populateEditableList('issues', data.issues || [], 'issue');
            populateEditableList('materials', data.materials || [], 'material');
            populateEditableList('nextSteps', data.nextSteps || [], 'simple');
            
            // Image gallery is now populated by renderCurrentImageGallery()
        }

        function populateEditableField(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value || ''; // Set text content
            }
        }

         function populateEditableList(id, items, itemType = 'simple') {
             const listElement = document.getElementById(id);
             if (!listElement) return;
             listElement.innerHTML = ''; // Clear loading/default
             items.forEach(item => {
                 addListItemElement(listElement, item, itemType);
             });
         }
         
         function addListItemElement(listElement, itemData, itemType) {
             const li = document.createElement('li');
             let content = '';
             let textToEdit = '';
             if (itemType === 'simple' && typeof itemData === 'string') {
                 textToEdit = itemData;
             } else if (itemType === 'issue' && typeof itemData === 'object') {
                 textToEdit = itemData.description || ''; // Assuming object structure { description: '...' }
             } else if (itemType === 'material' && typeof itemData === 'object') {
                  textToEdit = `${itemData.name || ''} (${itemData.quantity || ''} ${itemData.unit || ''})`; // Assuming { name: '..', quantity: '..', unit: '..'}
             } else {
                 textToEdit = JSON.stringify(itemData); // Fallback for unknown structure
             }

             li.innerHTML = `
                <div class="editable" contenteditable="true" data-item-type="${itemType}">${textToEdit}</div>
                <button class="remove-item-btn" title="Remove item">&times;</button>
            `;
             listElement.appendChild(li);
         }
         
         function addItemToList(listId, itemType) {
             const listElement = document.getElementById(listId);
             if (!listElement) return;
             // Add a new empty item element for editing
             const placeholderData = itemType === 'simple' ? '' : (itemType === 'issue' ? { description: '' } : { name: '', quantity: '', unit: '' });
             addListItemElement(listElement, placeholderData, itemType);
             // Optionally focus the new editable element
             const newEditable = listElement.lastElementChild?.querySelector('.editable');
             if (newEditable) {
                 newEditable.focus();
             }
         }

        function collectChanges() {
            if (!currentReportData) return;

            // Collect simple text fields
            currentReportData.narrative = document.getElementById('narrative')?.textContent.trim() || '';
            currentReportData.safetyObservations = document.getElementById('safetyObservations')?.textContent.trim() || '';

            // Collect list items
            currentReportData.workCompleted = collectListItems('workCompleted', 'simple');
            currentReportData.issues = collectListItems('issues', 'issue');
            currentReportData.materials = collectListItems('materials', 'material');
            currentReportData.nextSteps = collectListItems('nextSteps', 'simple');
            
            // Captions are updated via event listener 'updateCaptionFromEditable'
            // The currentReportData.images array is modified directly by add/remove handlers
            console.log("Collected changes:", currentReportData);
        }
        
        function collectListItems(listId, itemType) {
            const listElement = document.getElementById(listId);
            if (!listElement) return [];
            const items = [];
            listElement.querySelectorAll('li .editable').forEach(editable => {
                const text = editable.textContent.trim();
                if (text) { // Only add non-empty items
                     if (itemType === 'simple') {
                         items.push(text);
                     } else if (itemType === 'issue') {
                         items.push({ description: text }); // Assuming simple structure for now
                     } else if (itemType === 'material') {
                         // Basic parsing - might need improvement
                         const match = text.match(/^(.+?)\s*\((.+?)\s+(.+?)\)$/);
                         if (match) {
                             items.push({ name: match[1].trim(), quantity: match[2].trim(), unit: match[3].trim() });
                         } else {
                             items.push({ name: text, quantity: '', unit: '' }); // Fallback
                         }
                     }
                     // Add other type parsings if needed
                }
            });
            return items;
        }

        function saveChanges() {
            const saveButton = document.getElementById('saveButton');
            const statusMessage = document.getElementById('statusMessage');

            saveButton.disabled = true;
            statusMessage.textContent = 'Saving...';
            statusMessage.className = ''; // Clear previous classes
            statusMessage.style.display = 'block';

            console.log("Saving data:", currentReportData);

            fetch(`/api/report?key=${encodeURIComponent(reportKey)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(currentReportData),
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || `Save failed: ${response.status}`); });
                }
                return response.json();
            })
            .then(data => {
                console.log('Save successful:', data);
                statusMessage.textContent = data.message || 'Report saved successfully!';
                statusMessage.className = 'success'; // Add success class
            })
            .catch(error => {
                console.error('Error saving report:', error);
                statusMessage.textContent = `Error saving: ${error.message}`;
                statusMessage.className = 'error'; // Add error class
            })
            .finally(() => {
                saveButton.disabled = false;
                 // Hide status message after a few seconds
                setTimeout(() => { statusMessage.style.display = 'none'; }, 5000);
            });
        }

         function showError(message) {
             const container = document.querySelector('.container'); // Find the main container
             if (container) {
                 container.innerHTML = `<div class="error-message">${message}</div>`;
             }
         }

    </script>
</body>
</html>
